#!/bin/bash

# –ü–æ–ª–Ω–æ–µ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
# - Course endpoints (—Å prisma generate)
# - Step editor save fix
# - Learner submission validation
# - Mobile-friendly learner cards

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

echo "üöÄ –ü–æ–ª–Ω–æ–µ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π"
echo "=========================================="

# 1. –ü–æ–ª—É—á–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
echo ""
echo "üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∏–∑ Git..."
git pull

# 2. –û–±–Ω–æ–≤–∏—Ç—å Prisma Client (–¥–ª—è –º–æ–¥–µ–ª–∏ Course)
echo ""
echo "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Prisma Client..."
cd backend
npx prisma generate

# 3. –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å backend
echo ""
echo "üî® –°–±–æ—Ä–∫–∞ backend..."
npm run build

# 4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å backend
echo ""
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ backend..."
pm2 restart minto-backend

# 5. –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å TMA
echo ""
echo "üé® –°–±–æ—Ä–∫–∞ TMA (frontend)..."
cd ../tma
npm run build

# 6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã
echo ""
echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤..."
echo ""
echo "Backend (PM2):"
pm2 status

echo ""
echo "API –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å:"
curl -I https://tma.n8nrgimprovise.space/api/admin/courses | head -1

echo ""
echo "Backend –ª–æ–≥–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 15 —Å—Ç—Ä–æ–∫):"
pm2 logs minto-backend --lines 15 --nostream

echo ""
echo "üéâ –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo ""
echo "üìã –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:"
echo "  ‚úÖ Endpoints /admin/courses (Course entity)"
echo "  ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —à–∞–≥–æ–≤ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ –∫—É—Ä—Å–∞"
echo "  ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ —É—á–µ–Ω–∏–∫–∞–º–∏ (enrollment validation)"
echo "  ‚úÖ –ú–æ–±–∏–ª—å–Ω—ã–π UI –∫–∞—Ä—Ç–æ—á–µ–∫ —É—á–µ–Ω–∏–∫–æ–≤"
echo ""
echo "üß™ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ TMA:"
echo "  1. –í–∫–ª–∞–¥–∫–∞ '–ö—É—Ä—Å—ã' ‚Üí –¥–æ–ª–∂–µ–Ω –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è —Å–ø–∏—Å–æ–∫ –∫—É—Ä—Å–æ–≤"
echo "  2. –í–∫–ª–∞–¥–∫–∞ '–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä' ‚Üí —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —à–∞–≥–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç"
echo "  3. –í–∫–ª–∞–¥–∫–∞ '–£—á–µ–Ω–∏–∫–∏' ‚Üí –∫–∞—Ä—Ç–æ—á–∫–∏ –≤—ã–≥–ª—è–¥—è—Ç –∞–∫–∫—É—Ä–∞—Ç–Ω–æ"
echo "  4. –û—Ç –ª–∏—Ü–∞ —É—á–µ–Ω–∏–∫–∞ ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç"
echo ""


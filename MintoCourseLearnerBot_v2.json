{
  "name": "Minto Course Learner Bot v2",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "message",
          "callback_query"
        ],
        "additionalFields": {
          "download": true
        }
      },
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        240,
        300
      ],
      "id": "telegram-trigger-001",
      "name": "Telegram Trigger",
      "webhookId": "minto-bot-webhook",
      "credentials": {
        "telegramApi": {
          "id": "telegramApi",
          "name": "Telegram API"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Extract user data from Telegram update\nconst update = $input.item.json;\nlet tgId, messageText, callbackData, isCallback = false;\n\nif (update.callback_query) {\n  // Handle callback query (inline button click)\n  tgId = update.callback_query.from.id.toString();\n  callbackData = update.callback_query.data || '';\n  messageText = callbackData;\n  isCallback = true;\n} else if (update.message) {\n  // Handle regular message\n  tgId = update.message.from.id.toString();\n  messageText = update.message.text || '';\n  isCallback = false;\n}\n\nreturn {\n  json: {\n    tg_id: tgId,\n    message_text: messageText,\n    callback_data: callbackData || '',\n    is_callback: isCallback,\n    update: update\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        460,
        300
      ],
      "id": "extract-user-data",
      "name": "Extract User Data"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "",
          "mode": "id"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "tg_id",
              "keyValue": "={{ $json.tg_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        680,
        300
      ],
      "id": "get-user",
      "name": "Get User from Learners"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.items?.length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        900,
        300
      ],
      "id": "user-exists-check",
      "name": "User Exists?"
    },
    {
      "parameters": {
        "operation": "create",
        "dataTableId": {
          "__rl": true,
          "value": "",
          "mode": "id"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "tg_id": "={{ $('Extract User Data').item.json.tg_id }}",
            "first_name": "",
            "last_name": "",
            "position": "",
            "role": "learner",
            "state": "registration_waiting_name",
            "current_module": 0,
            "current_step": 0,
            "module1_done": false,
            "module2_done": false,
            "module3_done": false,
            "exam_done": false,
            "module2_unlocked": false,
            "module3_unlocked": false,
            "exam_unlocked": false,
            "last_answer_text": "",
            "last_answer_file": "",
            "last_activity_at": "={{ $now }}"
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        900,
        480
      ],
      "id": "create-user",
      "name": "Create New User"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "user-data",
              "name": "user",
              "value": "={{ $json.items[0] || $json }}",
              "type": "object"
            },
            {
              "id": "tg-id",
              "name": "tg_id",
              "value": "={{ $('Extract User Data').item.json.tg_id }}",
              "type": "string"
            },
            {
              "id": "message-text",
              "name": "message_text",
              "value": "={{ $('Extract User Data').item.json.message_text }}",
              "type": "string"
            },
            {
              "id": "is-callback",
              "name": "is_callback",
              "value": "={{ $('Extract User Data').item.json.is_callback }}",
              "type": "boolean"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1120,
        300
      ],
      "id": "prepare-user-context",
      "name": "Prepare User Context"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.user.role }}",
                    "rightValue": "curator",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "curator"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.user.role }}",
                    "rightValue": "learner",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "learner"
            }
          ]
        },
        "options": {
          "fallbackOutput": "fallback"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        1340,
        300
      ],
      "id": "switch-by-role",
      "name": "Switch by Role"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.user.state }}",
                    "rightValue": "registration_waiting_name",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "reg_name"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.user.state }}",
                    "rightValue": "registration_waiting_lastname",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "reg_lastname"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.user.state }}",
                    "rightValue": "registration_waiting_position",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "reg_position"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.user.state }}",
                    "rightValue": "idle",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "idle"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.user.state }}",
                    "rightValue": "m1_finished_wait_unlock",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "m1_wait_unlock"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.user.state }}",
                    "rightValue": "m2_finished_wait_unlock",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "m2_wait_unlock"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.user.state }}",
                    "rightValue": "m3_finished_wait_unlock",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "m3_wait_unlock"
            }
          ]
        },
        "options": {
          "fallbackOutput": "fallback"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        1560,
        420
      ],
      "id": "switch-learner-state",
      "name": "Switch Learner State"
    },
    {
      "parameters": {
        "chatId": "={{ $json.tg_id }}",
        "text": "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∫—É—Ä—Å ¬´–ü–∏—Ä–∞–º–∏–¥–∞ –ú–∏–Ω—Ç–æ¬ª!\n\n–î–ª—è –Ω–∞—á–∞–ª–∞ –æ–±—É—á–µ–Ω–∏—è –º–Ω–µ –Ω—É–∂–Ω–æ —É–∑–Ω–∞—Ç—å –Ω–µ–º–Ω–æ–≥–æ –æ –≤–∞—Å.\n\nüìù –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:",
        "additionalFields": {
          "reply_markup": {
            "remove_keyboard": true
          }
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1780,
        240
      ],
      "id": "reg-ask-name",
      "name": "Registration: Ask Name",
      "credentials": {
        "telegramApi": {
          "id": "telegramApi",
          "name": "Telegram API"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "",
          "mode": "id"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "tg_id",
              "keyValue": "={{ $json.tg_id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "first_name": "={{ $json.message_text }}",
            "state": "registration_waiting_lastname",
            "last_activity_at": "={{ $now }}"
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        2000,
        240
      ],
      "id": "update-name",
      "name": "Update: Save Name"
    },
    {
      "parameters": {
        "chatId": "={{ $json.tg_id }}",
        "text": "‚úÖ –ò–º—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!\n\nüìù –¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à—É —Ñ–∞–º–∏–ª–∏—é:",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2220,
        240
      ],
      "id": "reg-confirm-name",
      "name": "Registration: Confirm Name",
      "credentials": {
        "telegramApi": {
          "id": "telegramApi",
          "name": "Telegram API"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $json.tg_id }}",
        "text": "üìù –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à—É —Ñ–∞–º–∏–ª–∏—é:",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1780,
        360
      ],
      "id": "reg-ask-lastname",
      "name": "Registration: Ask Lastname",
      "credentials": {
        "telegramApi": {
          "id": "telegramApi",
          "name": "Telegram API"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "",
          "mode": "id"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "tg_id",
              "keyValue": "={{ $json.tg_id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "last_name": "={{ $json.message_text }}",
            "state": "registration_waiting_position",
            "last_activity_at": "={{ $now }}"
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        2000,
        360
      ],
      "id": "update-lastname",
      "name": "Update: Save Lastname"
    },
    {
      "parameters": {
        "chatId": "={{ $json.tg_id }}",
        "text": "‚úÖ –§–∞–º–∏–ª–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!\n\nüìù –¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à—É –¥–æ–ª–∂–Ω–æ—Å—Ç—å:",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2220,
        360
      ],
      "id": "reg-confirm-lastname",
      "name": "Registration: Confirm Lastname",
      "credentials": {
        "telegramApi": {
          "id": "telegramApi",
          "name": "Telegram API"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $json.tg_id }}",
        "text": "üìù –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à—É –¥–æ–ª–∂–Ω–æ—Å—Ç—å:",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1780,
        480
      ],
      "id": "reg-ask-position",
      "name": "Registration: Ask Position",
      "credentials": {
        "telegramApi": {
          "id": "telegramApi",
          "name": "Telegram API"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "",
          "mode": "id"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "tg_id",
              "keyValue": "={{ $json.tg_id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "position": "={{ $json.message_text }}",
            "state": "idle",
            "current_module": 1,
            "current_step": 0,
            "last_activity_at": "={{ $now }}"
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        2000,
        480
      ],
      "id": "update-position",
      "name": "Update: Save Position & Complete Registration"
    },
    {
      "parameters": {
        "chatId": "={{ $json.tg_id }}",
        "text": "‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n\nüéì –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∫—É—Ä—Å ¬´–ü–∏—Ä–∞–º–∏–¥–∞ –ú–∏–Ω—Ç–æ¬ª!\n\n–í—ã –≥–æ—Ç–æ–≤—ã –Ω–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.",
        "additionalFields": {
          "reply_markup": {
            "keyboard": [
              [
                {
                  "text": "üìö –ú–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å"
                },
                {
                  "text": "‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ"
                }
              ],
              [
                {
                  "text": "‚ùì –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –∫—É—Ä–∞—Ç–æ—Ä—É"
                },
                {
                  "text": "üìé –ú–æ–∏ —Å–¥–∞—á–∏"
                }
              ]
            ],
            "resize_keyboard": true,
            "one_time_keyboard": false
          }
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2220,
        480
      ],
      "id": "reg-complete",
      "name": "Registration: Complete",
      "credentials": {
        "telegramApi": {
          "id": "telegramApi",
          "name": "Telegram API"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.message_text }}",
                    "rightValue": "‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "continue_learning"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.message_text }}",
                    "rightValue": "üìö –ú–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "my_progress"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.message_text }}",
                    "rightValue": "üìé –ú–æ–∏ —Å–¥–∞—á–∏",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "my_submissions"
            }
          ]
        },
        "options": {
          "fallbackOutput": "fallback"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        1780,
        600
      ],
      "id": "switch-idle-menu",
      "name": "Switch: Idle Menu"
    },
    {
      "parameters": {
        "jsCode": "// Determine current module and step, prepare module content\nconst user = $input.item.json.user;\nconst currentModule = user.current_module || 1;\nconst currentStep = user.current_step || 0;\n\n// Module 1 structure (simplified - in production, load from course_structure table)\nconst module1Steps = [\n  {\n    step: 0,\n    type: 'info',\n    title: '–ú–æ–¥—É–ª—å 1: –ü—Ä–∏–Ω—Ü–∏–ø –ø–∏—Ä–∞–º–∏–¥—ã –ú–∏–Ω—Ç–æ',\n    text: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ú–æ–¥—É–ª—å 1!\n\n–í —ç—Ç–æ–º –º–æ–¥—É–ª–µ –≤—ã –∏–∑—É—á–∏—Ç–µ:\n‚Ä¢ –ß—Ç–æ —Ç–∞–∫–æ–µ ¬´–ü–∏—Ä–∞–º–∏–¥–∞ –ú–∏–Ω—Ç–æ¬ª\n‚Ä¢ –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ–≥–æ –º—ã—à–ª–µ–Ω–∏—è\n‚Ä¢ SCQR: Situation ‚Üí Complication ‚Üí Question ‚Üí Resolution\n‚Ä¢ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –Ω–∞ —Ä–∞–±–æ—á–∏—Ö –ø—Ä–∏–º–µ—Ä–∞—Ö'\n  },\n  {\n    step: 1,\n    type: 'task',\n    title: '–ó–∞–¥–∞–Ω–∏–µ –ú1.1: –†–∞–∑–±–æ—Ä SCQR',\n    text: '–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Ä–∞–±–æ—á–∏–π –∫–µ–π—Å –∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç–µ:\n‚Ä¢ Situation (–°–∏—Ç—É–∞—Ü–∏—è)\n‚Ä¢ Complication (–ü—Ä–æ–±–ª–µ–º–∞)\n‚Ä¢ Question (–í–æ–ø—Ä–æ—Å)\n‚Ä¢ Resolution (–†–µ—à–µ–Ω–∏–µ)\n\n–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –∞–Ω–∞–ª–∏–∑ –≤ —Å–≤–æ–±–æ–¥–Ω–æ–π —Ñ–æ—Ä–º–µ (100-150 —Å–ª–æ–≤).'\n  },\n  {\n    step: 2,\n    type: 'task',\n    title: '–ó–∞–¥–∞–Ω–∏–µ –ú1.2: –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å –ø–∏—Å—å–º–æ',\n    text: '–í–∞–º –¥–∞–Ω–æ —Ö–∞–æ—Ç–∏—á–Ω–æ–µ –ø–∏—Å—å–º–æ –∫–ª–∏–µ–Ω—Ç—É. –ü–µ—Ä–µ–ø–∏—à–∏—Ç–µ –µ–≥–æ –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É –ø–∏—Ä–∞–º–∏–¥—ã –ú–∏–Ω—Ç–æ:\n‚Ä¢ –ì–ª–∞–≤–Ω–∞—è –º—ã—Å–ª—å –≤ –Ω–∞—á–∞–ª–µ\n‚Ä¢ 2-3 –æ–ø–æ—Ä—ã –æ–¥–Ω–æ–≥–æ —Ç–∏–ø–∞\n‚Ä¢ –î–µ—Ç–∞–ª–∏ –∏ —Ñ–∞–∫—Ç—ã\n\n–û–±—ä–µ–º: 100-150 —Å–ª–æ–≤.'\n  },\n  {\n    step: 3,\n    type: 'task',\n    title: '–ó–∞–¥–∞–Ω–∏–µ –ú1.3: –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ',\n    text: '–°–æ–∑–¥–∞–π—Ç–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É –ø–∏—Ä–∞–º–∏–¥—ã –ú–∏–Ω—Ç–æ –Ω–∞ –ª—é–±—É—é —Ä–∞–±–æ—á—É—é —Ç–µ–º—É.\n\n–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:\n‚Ä¢ 100-150 —Å–ª–æ–≤\n‚Ä¢ –ì–ª–∞–≤–Ω–∞—è –º—ã—Å–ª—å –≤ –Ω–∞—á–∞–ª–µ\n‚Ä¢ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ–ø–æ—Ä—ã\n‚Ä¢ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ SCQR (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)'\n  },\n  {\n    step: 4,\n    type: 'quiz',\n    title: '–ö–≤–∏–∑ –ú–æ–¥—É–ª—è 1',\n    text: '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É –ø–∏—Ä–∞–º–∏–¥—ã –ú–∏–Ω—Ç–æ.'\n  }\n];\n\nlet stepData = null;\nif (currentModule === 1 && currentStep < module1Steps.length) {\n  stepData = module1Steps[currentStep];\n}\n\nreturn {\n  json: {\n    ...$input.item.json,\n    current_module: currentModule,\n    current_step: currentStep,\n    step_data: stepData\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2000,
        600
      ],
      "id": "prepare-module-content",
      "name": "Prepare Module Content"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.step_data?.type }}",
              "rightValue": "info",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2220,
        600
      ],
      "id": "check-step-type",
      "name": "Check Step Type"
    },
    {
      "parameters": {
        "chatId": "={{ $json.tg_id }}",
        "text": "={{ $json.step_data.title }}\n\n{{ $json.step_data.text }}\n\n---\n\n–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å:",
        "additionalFields": {
          "reply_markup": {
            "inline_keyboard": [
              [
                {
                  "text": "‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å",
                  "callback_data": "continue_step"
                }
              ]
            ]
          }
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2440,
        540
      ],
      "id": "send-info-step",
      "name": "Send Info Step",
      "credentials": {
        "telegramApi": {
          "id": "telegramApi",
          "name": "Telegram API"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "",
          "mode": "id"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "tg_id",
              "keyValue": "={{ $json.tg_id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "current_step": "={{ $json.current_step + 1 }}",
            "state": "={{ 'm' + $json.current_module + '_waiting_answer_s' + ($json.current_step + 1) }}",
            "last_activity_at": "={{ $now }}"
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        2660,
        540
      ],
      "id": "update-step-progress",
      "name": "Update Step Progress"
    },
    {
      "parameters": {
        "chatId": "={{ $json.tg_id }}",
        "text": "={{ $json.step_data.title }}\n\n{{ $json.step_data.text }}\n\n---\n\nüìù –û—Ç–ø—Ä–∞–≤—å—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç —Ç–µ–∫—Å—Ç–æ–º –∏–ª–∏ —Ñ–∞–π–ª–æ–º:",
        "additionalFields": {
          "reply_markup": {
            "inline_keyboard": [
              [
                {
                  "text": "‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç",
                  "callback_data": "submit_answer"
                }
              ],
              [
                {
                  "text": "‚Ü©Ô∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é",
                  "callback_data": "back_to_menu"
                }
              ]
            ]
          }
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2440,
        660
      ],
      "id": "send-task-step",
      "name": "Send Task Step",
      "credentials": {
        "telegramApi": {
          "id": "telegramApi",
          "name": "Telegram API"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "",
          "mode": "id"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "tg_id",
              "keyValue": "={{ $json.tg_id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "state": "={{ 'm' + $json.current_module + '_waiting_answer_s' + $json.current_step }}",
            "last_activity_at": "={{ $now }}"
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        2660,
        660
      ],
      "id": "update-state-waiting-answer",
      "name": "Update State: Waiting Answer"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.user.state }}",
                    "rightValue": "m1_waiting_answer_s1",
                    "operator": {
                      "type": "string",
                      "operation": "regex",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "m1_s1"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.user.state }}",
                    "rightValue": "m1_waiting_answer_s2",
                    "operator": {
                      "type": "string",
                      "operation": "regex",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "m1_s2"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.user.state }}",
                    "rightValue": "m1_waiting_answer_s3",
                    "operator": {
                      "type": "string",
                      "operation": "regex",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "m1_s3"
            }
          ]
        },
        "options": {
          "fallbackOutput": "fallback"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        1780,
        720
      ],
      "id": "switch-waiting-answer",
      "name": "Switch: Waiting Answer States"
    },
    {
      "parameters": {
        "jsCode": "// Extract answer from message or file\nconst update = $input.item.json.update;\nlet answerText = '';\nlet answerFile = '';\n\nif (update.message) {\n  if (update.message.text) {\n    answerText = update.message.text;\n  } else if (update.message.voice) {\n    answerFile = update.message.voice.file_id;\n    answerText = '[–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]';\n  } else if (update.message.video) {\n    answerFile = update.message.video.file_id;\n    answerText = '[–í–∏–¥–µ–æ —Å–æ–æ–±—â–µ–Ω–∏–µ]';\n  } else if (update.message.document) {\n    answerFile = update.message.document.file_id;\n    answerText = update.message.document.file_name || '[–§–∞–π–ª]';\n  }\n}\n\nconst user = $input.item.json.user;\nconst state = user.state;\n\n// Extract module and step from state (e.g., m1_waiting_answer_s2 -> module=1, step=2)\nconst match = state.match(/m(\\d+)_waiting_answer_s(\\d+)/);\nconst module = match ? parseInt(match[1]) : user.current_module;\nconst step = match ? parseInt(match[2]) : user.current_step;\n\nreturn {\n  json: {\n    ...$input.item.json,\n    answer_text: answerText,\n    answer_file: answerFile,\n    submission_module: module,\n    submission_step: step\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2000,
        720
      ],
      "id": "extract-answer",
      "name": "Extract Answer"
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "",
          "mode": "id"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "tg_id",
              "keyValue": "={{ $json.tg_id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "last_answer_text": "={{ $json.answer_text }}",
            "last_answer_file": "={{ $json.answer_file }}",
            "last_activity_at": "={{ $now }}"
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        2220,
        720
      ],
      "id": "save-answer-temp",
      "name": "Save Answer (Temp)"
    },
    {
      "parameters": {
        "chatId": "={{ $json.tg_id }}",
        "text": "‚úÖ –í–∞—à –æ—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω!\n\n–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É ¬´‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç¬ª, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –µ–≥–æ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É.",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2440,
        720
      ],
      "id": "confirm-answer-saved",
      "name": "Confirm Answer Saved",
      "credentials": {
        "telegramApi": {
          "id": "telegramApi",
          "name": "Telegram API"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.callback_data }}",
              "rightValue": "submit_answer",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2220,
        840
      ],
      "id": "check-submit-callback",
      "name": "Check: Submit Callback"
    },
    {
      "parameters": {
        "operation": "create",
        "dataTableId": {
          "__rl": true,
          "value": "",
          "mode": "id"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "tg_id": "={{ $json.tg_id }}",
            "module": "={{ $json.user.current_module }}",
            "step": "={{ $json.user.current_step }}",
            "answer_text": "={{ $json.user.last_answer_text }}",
            "answer_file": "={{ $json.user.last_answer_file }}",
            "status": "new",
            "created_at": "={{ $now }}"
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        2440,
        840
      ],
      "id": "create-submission",
      "name": "Create Submission"
    },
    {
      "parameters": {
        "model": "gpt-4",
        "messages": {
          "values": [
            {
              "role": "system",
              "content": "–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É –ø–∏—Ä–∞–º–∏–¥—ã –ú–∏–Ω—Ç–æ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ–π –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –æ—Ü–µ–Ω–∏–≤–∞—Ç—å –æ—Ç–≤–µ—Ç—ã –æ–±—É—á–∞—é—â–∏—Ö—Å—è –ø–æ —Å–ª–µ–¥—É—é—â–∏–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º:\n\n1. **–ì–ª–∞–≤–Ω–∞—è –º—ã—Å–ª—å –≤ –Ω–∞—á–∞–ª–µ** (0-3 –±–∞–ª–ª–∞)\n   - –ï—Å—Ç—å –ª–∏ —á–µ—Ç–∫–∞—è –≥–ª–∞–≤–Ω–∞—è –º—ã—Å–ª—å –≤ –Ω–∞—á–∞–ª–µ —Ç–µ–∫—Å—Ç–∞?\n   - –ü–æ–Ω—è—Ç–Ω–∞ –ª–∏ –æ–Ω–∞ —Å—Ä–∞–∑—É?\n\n2. **–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ–ø–æ—Ä—ã** (0-3 –±–∞–ª–ª–∞)\n   - –ï—Å—Ç—å –ª–∏ 2-3 –æ–ø–æ—Ä—ã –æ–¥–Ω–æ–≥–æ —Ç–∏–ø–∞?\n   - –õ–æ–≥–∏—á–Ω–æ –ª–∏ –æ–Ω–∏ —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω—ã?\n\n3. **–î–µ—Ç–∞–ª–∏ –∏ —Ñ–∞–∫—Ç—ã** (0-2 –±–∞–ª–ª–∞)\n   - –ü–æ–¥–∫—Ä–µ–ø–ª–µ–Ω—ã –ª–∏ –æ–ø–æ—Ä—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –¥–µ—Ç–∞–ª—è–º–∏?\n   - –ï—Å—Ç—å –ª–∏ –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –ø—Ä–∏–º–µ—Ä—ã?\n\n4. **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ SCQR** (0-2 –±–∞–ª–ª–∞, –µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ)\n   - –ß–µ—Ç–∫–æ –ª–∏ –≤—ã–¥–µ–ª–µ–Ω—ã Situation, Complication, Question, Resolution?\n\n**–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–ª: 10**\n\n–í–µ—Ä–Ω–∏ –æ—Ç–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:\n{\n  \"score\": —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 10,\n  \"feedback\": \"—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏\"\n}"
            },
            {
              "role": "user",
              "content": "–ó–∞–¥–∞–Ω–∏–µ: {{ $json.user.current_module === 1 ? '–†–∞–∑–±–æ—Ä SCQR –Ω–∞ —Ä–∞–±–æ—á–∏—Ö –∫–µ–π—Å–∞—Ö' : '–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ' }}\n\n–û—Ç–≤–µ—Ç –æ–±—É—á–∞—é—â–µ–≥–æ—Å—è:\n{{ $json.user.last_answer_text }}\n\n–û—Ü–µ–Ω–∏ –æ—Ç–≤–µ—Ç –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º –≤—ã—à–µ."
            }
          ]
        },
        "options": {
          "temperature": 0.7,
          "maxTokens": 1000
        }
      },
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 1.3,
      "position": [
        2660,
        840
      ],
      "id": "openai-review",
      "name": "OpenAI: Review Submission",
      "credentials": {
        "openAiApi": {
          "id": "openAiApi",
          "name": "OpenAI API"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse OpenAI response\nconst openaiResponse = $input.item.json.choices[0].message.content;\nlet aiFeedback = '';\nlet aiScore = 0;\n\ntry {\n  const parsed = JSON.parse(openaiResponse);\n  aiScore = parsed.score || 0;\n  aiFeedback = parsed.feedback || openaiResponse;\n} catch (e) {\n  // If not JSON, use as-is\n  aiFeedback = openaiResponse;\n  // Try to extract score from text\n  const scoreMatch = openaiResponse.match(/[0-9]+(?:\\.[0-9]+)?/);\n  if (scoreMatch) {\n    aiScore = parseFloat(scoreMatch[0]);\n  }\n}\n\nreturn {\n  json: {\n    ...$('Create Submission').item.json,\n    ai_feedback: aiFeedback,\n    ai_score: aiScore\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2880,
        840
      ],
      "id": "parse-ai-response",
      "name": "Parse AI Response"
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "",
          "mode": "id"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "keyValue": "={{ $json.id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "ai_feedback": "={{ $json.ai_feedback }}",
            "ai_score": "={{ $json.ai_score }}",
            "status": "ai_reviewed"
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        3100,
        840
      ],
      "id": "update-submission-ai",
      "name": "Update Submission: AI Review"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "",
          "mode": "id"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "role",
              "keyValue": "curator"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        3320,
        840
      ],
      "id": "get-curators",
      "name": "Get Curators"
    },
    {
      "parameters": {
        "chatId": "={{ $json.items[0].tg_id }}",
        "text": "üì¨ –ù–æ–≤–∞—è —Å–¥–∞—á–∞ –∑–∞–¥–∞–Ω–∏—è\n\nüë§ –£—á–∞—Å—Ç–Ω–∏–∫: {{ $('Prepare User Context').item.json.user.first_name }} {{ $('Prepare User Context').item.json.user.last_name }}\nüìö –ú–æ–¥—É–ª—å: {{ $('Prepare User Context').item.json.user.current_module }}\nüìù –®–∞–≥: {{ $('Prepare User Context').item.json.user.current_step }}\n\nü§ñ –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –ò–ò: {{ $('Parse AI Response').item.json.ai_score }}/10\n\nüí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ò–ò:\n{{ $('Parse AI Response').item.json.ai_feedback }}\n\n---\n\n–û—Ç–≤–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–∞:\n{{ $('Prepare User Context').item.json.user.last_answer_text }}\n\n---\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        "additionalFields": {
          "reply_markup": {
            "inline_keyboard": [
              [
                {
                  "text": "‚úÖ –û–¥–æ–±—Ä–∏—Ç—å",
                  "callback_data": "curator_approve_{{ $('Create Submission').item.json.id }}"
                },
                {
                  "text": "‚Ü©Ô∏è –í–µ—Ä–Ω—É—Ç—å –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É",
                  "callback_data": "curator_return_{{ $('Create Submission').item.json.id }}"
                }
              ]
            ]
          }
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        3540,
        840
      ],
      "id": "notify-curator",
      "name": "Notify Curator",
      "credentials": {
        "telegramApi": {
          "id": "telegramApi",
          "name": "Telegram API"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Prepare User Context').item.json.tg_id }}",
        "text": "‚úÖ –í–∞—à –æ—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É!\n\nü§ñ –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –ò–ò: {{ $('Parse AI Response').item.json.ai_score }}/10\n\nüí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ò–ò:\n{{ $('Parse AI Response').item.json.ai_feedback }}\n\n–û–∂–∏–¥–∞–π—Ç–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –æ—Ü–µ–Ω–∫–∏ –æ—Ç –∫—É—Ä–∞—Ç–æ—Ä–∞.",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        3320,
        960
      ],
      "id": "notify-learner-submitted",
      "name": "Notify Learner: Submitted",
      "credentials": {
        "telegramApi": {
          "id": "telegramApi",
          "name": "Telegram API"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "",
          "mode": "id"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "tg_id",
              "keyValue": "={{ $('Prepare User Context').item.json.tg_id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "current_step": "={{ $('Prepare User Context').item.json.user.current_step + 1 }}",
            "state": "idle",
            "last_activity_at": "={{ $now }}"
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        3540,
        960
      ],
      "id": "update-after-submission",
      "name": "Update After Submission"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.user.state }}",
                    "rightValue": "curator_menu",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "curator_menu"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.user.state }}",
                    "rightValue": "curator_unlock_module",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "curator_unlock"
            }
          ]
        },
        "options": {
          "fallbackOutput": "fallback"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        1560,
        180
      ],
      "id": "switch-curator-state",
      "name": "Switch Curator State"
    },
    {
      "parameters": {
        "chatId": "={{ $json.tg_id }}",
        "text": "üë®‚Äçüè´ –ü–∞–Ω–µ–ª—å –∫—É—Ä–∞—Ç–æ—Ä–∞\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        "additionalFields": {
          "reply_markup": {
            "inline_keyboard": [
              [
                {
                  "text": "üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏",
                  "callback_data": "curator_participants"
                }
              ],
              [
                {
                  "text": "üîì –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥—É–ª—å",
                  "callback_data": "curator_unlock_module"
                }
              ],
              [
                {
                  "text": "‚úâÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫—É",
                  "callback_data": "curator_message"
                }
              ],
              [
                {
                  "text": "üì¢ –†–∞—Å—Å—ã–ª–∫–∞",
                  "callback_data": "curator_broadcast"
                }
              ],
              [
                {
                  "text": "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞",
                  "callback_data": "curator_stats"
                }
              ]
            ]
          }
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1780,
        180
      ],
      "id": "curator-menu",
      "name": "Curator Menu",
      "credentials": {
        "telegramApi": {
          "id": "telegramApi",
          "name": "Telegram API"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "",
          "mode": "id"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "tg_id",
              "keyValue": "={{ $json.tg_id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "state": "curator_menu",
            "last_activity_at": "={{ $now }}"
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        2000,
        180
      ],
      "id": "update-curator-state-menu",
      "name": "Update Curator State: Menu"
    },
    {
      "parameters": {
        "chatId": "={{ $json.tg_id }}",
        "text": "üîì –û—Ç–∫—Ä—ã—Ç–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–æ–¥—É–ª—é\n\n–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥—É–ª—å –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è:",
        "additionalFields": {
          "reply_markup": {
            "inline_keyboard": [
              [
                {
                  "text": "–ú–æ–¥—É–ª—å 2",
                  "callback_data": "unlock_module_2"
                }
              ],
              [
                {
                  "text": "–ú–æ–¥—É–ª—å 3",
                  "callback_data": "unlock_module_3"
                }
              ],
              [
                {
                  "text": "–≠–∫–∑–∞–º–µ–Ω",
                  "callback_data": "unlock_exam"
                }
              ],
              [
                {
                  "text": "‚Ü©Ô∏è –ù–∞–∑–∞–¥",
                  "callback_data": "curator_back"
                }
              ]
            ]
          }
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1780,
        300
      ],
      "id": "curator-unlock-menu",
      "name": "Curator: Unlock Menu",
      "credentials": {
        "telegramApi": {
          "id": "telegramApi",
          "name": "Telegram API"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $json.tg_id }}",
        "text": "–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ—Ç–∫—Ä—ã—Ç–∏—è:\n\n‚Ä¢ –û—Ç–∫—Ä—ã—Ç—å –≤—Å–µ–º, –∫—Ç–æ –ø—Ä–æ—à–µ–ª –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–æ–¥—É–ª—å\n‚Ä¢ –í—ã–±—Ä–∞—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤—Ä—É—á–Ω—É—é",
        "additionalFields": {
          "reply_markup": {
            "inline_keyboard": [
              [
                {
                  "text": "‚úÖ –û—Ç–∫—Ä—ã—Ç—å –≤—Å–µ–º",
                  "callback_data": "unlock_all_2"
                }
              ],
              [
                {
                  "text": "üë• –í—ã–±—Ä–∞—Ç—å –≤—Ä—É—á–Ω—É—é",
                  "callback_data": "unlock_select_2"
                }
              ]
            ]
          }
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2000,
        300
      ],
      "id": "curator-unlock-options",
      "name": "Curator: Unlock Options",
      "credentials": {
        "telegramApi": {
          "id": "telegramApi",
          "name": "Telegram API"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "",
          "mode": "id"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "state",
              "keyValue": "m1_finished_wait_unlock"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "module2_unlocked": true,
            "current_module": 2,
            "current_step": 0,
            "state": "idle",
            "last_activity_at": "={{ $now }}"
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        2220,
        300
      ],
      "id": "unlock-module-2-all",
      "name": "Unlock Module 2: All"
    },
    {
      "parameters": {
        "chatId": "={{ $json.tg_id }}",
        "text": "‚úÖ –ú–æ–¥—É–ª—å 2 –æ—Ç–∫—Ä—ã—Ç –¥–ª—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –∑–∞–≤–µ—Ä—à–∏–≤—à–∏—Ö –ú–æ–¥—É–ª—å 1!",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2440,
        300
      ],
      "id": "confirm-unlock",
      "name": "Confirm Unlock",
      "credentials": {
        "telegramApi": {
          "id": "telegramApi",
          "name": "Telegram API"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $json.tg_id }}",
        "text": "‚úÖ –ú–æ–¥—É–ª—å –∑–∞–≤–µ—Ä—à–µ–Ω!\n\n–í—ã –ø—Ä–æ—à–ª–∏ –ú–æ–¥—É–ª—å {{ $json.user.current_module }}. –ñ–¥–∏—Ç–µ –æ—Ç–∫—Ä—ã—Ç–∏—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –º–æ–¥—É–ª—è –∫—É—Ä–∞—Ç–æ—Ä–æ–º.",
        "additionalFields": {
          "reply_markup": {
            "keyboard": [
              [
                {
                  "text": "üìö –ú–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å"
                }
              ]
            ],
            "resize_keyboard": true
          }
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2000,
        600
      ],
      "id": "module-complete",
      "name": "Module Complete",
      "credentials": {
        "telegramApi": {
          "id": "telegramApi",
          "name": "Telegram API"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "",
          "mode": "id"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "tg_id",
              "keyValue": "={{ $json.tg_id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "module1_done": true,
            "state": "m1_finished_wait_unlock",
            "last_activity_at": "={{ $now }}"
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        2220,
        600
      ],
      "id": "mark-module-1-done",
      "name": "Mark Module 1 Done"
    }
  ],
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Extract User Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract User Data": {
      "main": [
        [
          {
            "node": "Get User from Learners",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get User from Learners": {
      "main": [
        [
          {
            "node": "User Exists?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "User Exists?": {
      "main": [
        [
          {
            "node": "Prepare User Context",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Create New User",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create New User": {
      "main": [
        [
          {
            "node": "Prepare User Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare User Context": {
      "main": [
        [
          {
            "node": "Switch by Role",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch by Role": {
      "main": [
        [
          {
            "node": "Switch Curator State",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Switch Learner State",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch Learner State": {
      "main": [
        [
          {
            "node": "Registration: Ask Name",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Registration: Ask Lastname",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Registration: Ask Position",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Switch: Idle Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Module Complete",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Module Complete",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Module Complete",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Registration: Ask Name": {
      "main": [
        [
          {
            "node": "Update: Save Name",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update: Save Name": {
      "main": [
        [
          {
            "node": "Registration: Confirm Name",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Registration: Ask Lastname": {
      "main": [
        [
          {
            "node": "Update: Save Lastname",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update: Save Lastname": {
      "main": [
        [
          {
            "node": "Registration: Confirm Lastname",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Registration: Ask Position": {
      "main": [
        [
          {
            "node": "Update: Save Position & Complete Registration",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update: Save Position & Complete Registration": {
      "main": [
        [
          {
            "node": "Registration: Complete",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch: Idle Menu": {
      "main": [
        [
          {
            "node": "Prepare Module Content",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare Module Content",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare Module Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Module Content": {
      "main": [
        [
          {
            "node": "Check Step Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Step Type": {
      "main": [
        [
          {
            "node": "Send Info Step",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Task Step",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Info Step": {
      "main": [
        [
          {
            "node": "Update Step Progress",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Task Step": {
      "main": [
        [
          {
            "node": "Update State: Waiting Answer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch: Waiting Answer States": {
      "main": [
        [
          {
            "node": "Extract Answer",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract Answer",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract Answer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Answer": {
      "main": [
        [
          {
            "node": "Save Answer (Temp)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Answer (Temp)": {
      "main": [
        [
          {
            "node": "Confirm Answer Saved",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check: Submit Callback": {
      "main": [
        [
          {
            "node": "Create Submission",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Submission": {
      "main": [
        [
          {
            "node": "OpenAI: Review Submission",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI: Review Submission": {
      "main": [
        [
          {
            "node": "Parse AI Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse AI Response": {
      "main": [
        [
          {
            "node": "Update Submission: AI Review",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Submission: AI Review": {
      "main": [
        [
          {
            "node": "Get Curators",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Curators": {
      "main": [
        [
          {
            "node": "Notify Curator",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Notify Curator": {
      "main": [
        []
      ]
    },
    "Notify Learner: Submitted": {
      "main": [
        [
          {
            "node": "Update After Submission",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch Curator State": {
      "main": [
        [
          {
            "node": "Curator Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Curator: Unlock Menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Curator Menu": {
      "main": [
        [
          {
            "node": "Update Curator State: Menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Curator: Unlock Menu": {
      "main": [
        [
          {
            "node": "Curator: Unlock Options",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Curator: Unlock Options": {
      "main": [
        [
          {
            "node": "Unlock Module 2: All",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Unlock Module 2: All": {
      "main": [
        [
          {
            "node": "Confirm Unlock",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Module Complete": {
      "main": [
        [
          {
            "node": "Mark Module 1 Done",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2024-01-01T00:00:00.000Z",
  "versionId": "1"
}


#!/bin/bash

# –ë—ã—Å—Ç—Ä–æ–µ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –Ω–∞ VPS
# –í–µ—Ä—Å–∏—è 2.0 (2025-11-29)

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–µ

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π..."

# –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd /var/www/tma_education

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ backend
echo "‚è∏Ô∏è  –û—Å—Ç–∞–Ω–æ–≤–∫–∞ backend..."
cd backend
pm2 stop minto-backend || echo "Backend —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

# –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
echo "üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∏–∑ Git..."
cd /var/www/tma_education
git pull

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –ë–î
echo "üóÑÔ∏è  –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –ë–î..."
cd backend
npx prisma migrate deploy

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
echo "üë• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π..."
psql -U minto_user -d minto_db -c "UPDATE \"User\" SET \"profileCompleted\" = true WHERE \"firstName\" IS NOT NULL AND \"lastName\" IS NOT NULL;" || echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–≤–æ–∑–º–æ–∂–Ω–æ, —É–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã)"

# –°–±–æ—Ä–∫–∞ backend
echo "üî® –°–±–æ—Ä–∫–∞ backend..."
npm run build

# –ó–∞–ø—É—Å–∫ backend
echo "‚ñ∂Ô∏è  –ó–∞–ø—É—Å–∫ backend..."
pm2 restart minto-backend || pm2 start dist/main.js --name minto-backend

# –°–±–æ—Ä–∫–∞ TMA
echo "üî® –°–±–æ—Ä–∫–∞ TMA..."
cd /var/www/tma_education/tma
npm run build

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ Caddy
echo "üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ Caddy..."
sudo systemctl reload caddy

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
echo ""
echo "‚úÖ –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo ""
echo "üìä –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:"
pm2 status

echo ""
echo "üìù –õ–æ–≥–∏ backend:"
pm2 logs minto-backend --lines 10 --nostream

echo ""
echo "üéâ –ì–æ—Ç–æ–≤–æ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É —Å–∏—Å—Ç–µ–º—ã:"
echo "   1. –û—Ç–∫—Ä–æ–π—Ç–µ Telegram –±–æ—Ç–∞ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ /start"
echo "   2. –û—Ç–∫—Ä–æ–π—Ç–µ TMA —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ –±–æ—Ç–µ"
echo "   3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –Ω–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç –¥–∏–∞–ª–æ–≥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏"
echo ""


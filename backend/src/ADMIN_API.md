# Админ API для кураторов

Документация эндпоинтов для управления курсом кураторами и администраторами.

## Аутентификация и права доступа

Все админ-эндпоинты требуют:
1. JWT токен в заголовке `Authorization: Bearer <token>`
2. Роль `CURATOR` или `ADMIN`

Используется `RolesGuard` для проверки прав доступа.

---

## Управление обучающимися

### GET /admin/learners

Список всех обучающихся с их прогрессом по модулям.

**Использование:**
- Для страницы "Список участников" в TMA куратора
- Показывает прогресс по модулям и количество сдач

**Ответ включает:**
- Информацию о пользователе
- Список enrollments с статусами модулей
- Статистику: общее количество сдач, сдачи на проверке

---

### GET /admin/learners/:id

Детальный прогресс конкретного пользователя.

**Использование:**
- Для страницы "Участник" в TMA куратора
- Показывает полную информацию о прогрессе

**Ответ включает:**
- Все enrollments с информацией о том, кто открыл модуль
- Последние 10 сдач
- Статистику: общее количество, одобренные, на проверке, возвращённые

---

## Управление модулями

### POST /admin/modules/:moduleId/unlock

Открыть модуль для пользователей.

**Варианты использования:**

1. **Открыть конкретным пользователям:**
```json
{
  "userIds": ["user_id_1", "user_id_2"]
}
```

2. **Открыть всем, кто завершил предыдущий модуль:**
```json
{
  "allCompletedPrevious": true
}
```

**Логика:**
- Если `allCompletedPrevious = true`:
  - Для первого модуля (index = 1) - открывает всем обучающимся
  - Для остальных - открывает только тем, кто завершил предыдущий модуль (status = COMPLETED)
- Если указаны `userIds` - открывает только указанным пользователям

**Действия:**
- Создаёт новый Enrollment, если его нет
- Обновляет существующий Enrollment:
  - `status = IN_PROGRESS`
  - `unlockedById = curatorId`
  - `unlockedAt = текущая дата`

**Ответ:**
```json
{
  "unlocked": 5,
  "message": "Module unlocked for 5 user(s)"
}
```

---

## Управление сдачами

### GET /admin/submissions

Список сдач с фильтрами.

**Query параметры:**
- `moduleId` (optional) - фильтр по модулю
- `status` (optional) - фильтр по статусу:
  - `SENT` - отправлено
  - `AI_REVIEWED` - проверено ИИ
  - `CURATOR_APPROVED` - одобрено куратором
  - `CURATOR_RETURNED` - возвращено на доработку

**Использование:**
- Для страницы "Сдачи на проверке" в TMA куратора
- Можно фильтровать по модулю или статусу

**Примеры:**
```
GET /admin/submissions?status=AI_REVIEWED
GET /admin/submissions?moduleId=module_id&status=SENT
```

---

### POST /admin/submissions/:id/approve

Одобрить сдачу.

**Request:**
```json
{
  "curatorScore": 8.5,
  "curatorFeedback": "Отличная работа! Хорошо структурировано."
}
```

**Логика:**
- Обновляет статус на `CURATOR_APPROVED`
- Сохраняет оценку и комментарий куратора
- Валидирует оценку (0 <= score <= maxScore)
- Автоматически проверяет завершение модуля:
  - Если все обязательные шаги одобрены → обновляет Enrollment.status = COMPLETED

**Использование:**
- Для кнопки "Одобрить" в уведомлении Telegram или в TMA

---

### POST /admin/submissions/:id/return

Вернуть сдачу на доработку.

**Request:**
```json
{
  "curatorFeedback": "Нужно доработать структуру. Главная мысль должна быть в начале."
}
```

**Логика:**
- Обновляет статус на `CURATOR_RETURNED`
- Сохраняет комментарий куратора
- Оценка не выставляется

**Использование:**
- Для кнопки "Вернуть на доработку" в уведомлении Telegram или в TMA

---

## Проверка ролей

Все админ-эндпоинты защищены `RolesGuard`:

```typescript
@UseGuards(JwtAuthGuard, RolesGuard)
@Roles(UserRole.CURATOR, UserRole.ADMIN)
```

**Поведение:**
- Если пользователь не аутентифицирован → `401 Unauthorized`
- Если роль не соответствует → `403 Forbidden`
- Если роль соответствует → доступ разрешён

---

## Примеры использования

### Открыть Модуль 2 всем, кто завершил Модуль 1

```bash
POST /admin/modules/{module2_id}/unlock
{
  "allCompletedPrevious": true
}
```

### Открыть Модуль 3 конкретным пользователям

```bash
POST /admin/modules/{module3_id}/unlock
{
  "userIds": ["user_id_1", "user_id_2", "user_id_3"]
}
```

### Получить все сдачи на проверке

```bash
GET /admin/submissions?status=AI_REVIEWED
```

### Одобрить сдачу

```bash
POST /admin/submissions/{submission_id}/approve
{
  "curatorScore": 9.0,
  "curatorFeedback": "Отлично! Все критерии выполнены."
}
```

### Вернуть сдачу на доработку

```bash
POST /admin/submissions/{submission_id}/return
{
  "curatorFeedback": "Нужно добавить больше деталей и примеров."
}
```

---

## Интеграция с Telegram Bot

Админ-эндпоинты могут использоваться:
1. **Через TMA** - куратор работает в веб-интерфейсе
2. **Через Telegram Bot** - куратор получает уведомления и использует inline-кнопки:
   - "Одобрить" → вызывает `POST /admin/submissions/:id/approve`
   - "Вернуть" → вызывает `POST /admin/submissions/:id/return`


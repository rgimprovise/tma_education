# Бизнес-логика для обучающегося

Документация реализованной бизнес-логики системы обучения.

## CourseService

### getModulesWithProgress(userId: string)

Возвращает список всех модулей с их статусами для пользователя.

**Логика определения статуса:**

1. **LOCKED** - модуль заблокирован:
   - Нет Enrollment для этого модуля
   - Или Enrollment существует, но статус LOCKED

2. **IN_PROGRESS** - модуль в процессе:
   - Есть Enrollment со статусом IN_PROGRESS
   - И не все обязательные шаги завершены

3. **COMPLETED** - модуль завершён:
   - Все обязательные шаги (TASK, QUIZ, EXAM, не INFO) имеют Submission со статусом CURATOR_APPROVED
   - Автоматически обновляется при проверке

**Особенности:**
- Использует данные из БД, не зашивает логику модулей
- Автоматически проверяет завершение модуля при запросе
- Возвращает enrollment даже для LOCKED модулей (с пустым id)

### getCurrentModule(userId: string)

Определяет текущий модуль для кнопки "Продолжить обучение".

**Логика:**
1. Ищет первый модуль со статусом **IN_PROGRESS**
2. Если не найден, возвращает первый модуль со статусом **LOCKED**
3. Если ничего не найдено, возвращает `null`

**Использование:**
- Для кнопки "Продолжить обучение" на главном экране TMA
- Возвращает модуль, который пользователь должен проходить следующим

### getModuleStepsWithProgress(moduleId: string, userId: string)

Возвращает список шагов модуля с их состоянием для пользователя.

**Состояния шага:**
- **Не начато** - `submission === undefined`
- **Отправлено** - `submission.status === 'SENT'`
- **На проверке** - `submission.status === 'AI_REVIEWED'`
- **Зачтено** - `submission.status === 'CURATOR_APPROVED'`
- **Возвращено** - `submission.status === 'CURATOR_RETURNED'`

**Возвращает:**
- Все шаги модуля в порядке их индекса
- Для каждого шага - информацию о сдаче (если есть)
- Оценки ИИ и куратора (если есть)

### getStepWithProgress(stepId: string, userId: string)

Возвращает детальную информацию о шаге с прогрессом пользователя.

**Использование:**
- Для страницы задания в TMA
- Показывает контент шага и состояние сдачи

---

## SubmissionsService

### create(data: CreateSubmissionDto)

Создаёт сдачу задания с полной валидацией.

**Валидация:**

1. **Шаг существует** - проверяет наличие шага в БД
2. **Шаг принадлежит модулю** - проверяет соответствие stepId и moduleId
3. **Шаг не INFO** - нельзя сдать информационный шаг
4. **Модуль доступен** - Enrollment должен иметь статус IN_PROGRESS
5. **Нельзя сдать дважды** - проверяет, что пользователь ещё не сдавал этот шаг
6. **Тип ответа соответствует** - проверяет соответствие answerType и expectedAnswer
7. **Наличие ответа** - для TEXT требуется answerText, для остальных - answerFileId

**Ошибки:**
- `NotFoundException` - шаг не найден
- `BadRequestException` - неверные данные (шаг INFO, уже сдано, неверный тип ответа)
- `ForbiddenException` - модуль недоступен

**После создания:**
- Если `step.requiresAiReview === true`, запускается асинхронная проверка через ИИ
- Submission получает статус `SENT`, затем обновляется до `AI_REVIEWED`

### updateStatus(id, status, curatorScore?, curatorFeedback?)

Обновляет статус сдачи (используется куратором).

**Валидация:**
- Проверяет существование Submission
- Валидирует оценку (0 <= score <= maxScore)

**Логика:**
- При статусе `CURATOR_APPROVED` проверяет завершение модуля
- Автоматически обновляет Enrollment.status на `COMPLETED`, если все шаги завершены

**Статусы:**
- `CURATOR_APPROVED` - сдача одобрена, модуль может быть завершён
- `CURATOR_RETURNED` - сдача возвращена на доработку

### checkAndCompleteModule(moduleId, userId) [private]

Проверяет завершение модуля и обновляет Enrollment.

**Логика:**
1. Получает все обязательные шаги модуля (не INFO)
2. Проверяет, что все шаги имеют Submission со статусом `CURATOR_APPROVED`
3. Если да - обновляет Enrollment:
   - `status = COMPLETED`
   - `completedAt = текущая дата`

**Особенности:**
- Вызывается автоматически при одобрении сдачи
- Не блокирует основной поток (асинхронно)
- Использует данные из БД, не зашивает логику модулей

---

## Принципы реализации

### 1. Использование данных БД
- Вся логика основана на данных из БД
- Нет зашитых значений модулей/шагов в коде
- Легко расширять через добавление записей в БД

### 2. Автоматическая проверка завершения
- Модуль автоматически помечается как завершённый при проверке
- Не требует ручного обновления статуса

### 3. Валидация на всех уровнях
- Проверка доступности модуля
- Проверка типа шага
- Проверка типа ответа
- Защита от повторной сдачи

### 4. Расширяемость
- Легко добавить новые типы шагов
- Легко изменить критерии завершения модуля
- Легко добавить новые типы ответов

---

## Примеры использования

### Получить список модулей с прогрессом
```typescript
const modules = await courseService.getModulesWithProgress(userId);
// modules[0].enrollment.status === 'LOCKED' | 'IN_PROGRESS' | 'COMPLETED'
```

### Получить текущий модуль для кнопки "Продолжить"
```typescript
const currentModule = await courseService.getCurrentModule(userId);
if (currentModule) {
  // Показать кнопку "Продолжить обучение"
}
```

### Создать сдачу
```typescript
try {
  const submission = await submissionsService.create({
    userId: 'user_id',
    stepId: 'step_id',
    moduleId: 'module_id',
    answerText: 'Мой ответ...',
    answerType: 'TEXT',
  });
} catch (error) {
  // Обработка ошибок валидации
}
```

### Обновить статус сдачи (куратор)
```typescript
await submissionsService.updateStatus(
  submissionId,
  'CURATOR_APPROVED',
  8.5,
  'Отличная работа!'
);
```


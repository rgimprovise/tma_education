// Prisma Schema для системы обучения «Пирамида Минто»
// Соответствует спецификации из SPEC_Minto_TMA.md

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Пользователи системы
model User {
  id           String   @id @default(cuid())
  telegramId   String   @unique // Telegram ID пользователя
  firstName    String?
  lastName     String?
  position     String?  // Должность
  role         UserRole @default(LEARNER)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  enrollments  Enrollment[]
  submissions  Submission[]
  unlockedEnrollments Enrollment[] @relation("UnlockedBy") // Модули, которые открыл этот куратор
}

enum UserRole {
  LEARNER
  CURATOR
  ADMIN
}

// Модули курса (1-3 + экзамен)
model CourseModule {
  id          String        @id @default(cuid())
  index       Int           @unique // 1,2,3,4 (4 = экзамен)
  title       String
  description String?
  isExam      Boolean       @default(false)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  steps       CourseStep[]
  enrollments Enrollment[]
}

// Шаги/задания внутри модулей
model CourseStep {
  id               String          @id @default(cuid())
  module           CourseModule    @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  moduleId         String
  index            Int             // порядок в модуле (0, 1, 2, ...)
  type             StepType        // INFO, TASK, QUIZ, EXAM
  title            String
  content          String          // текст задания / теории
  requiresAiReview Boolean         @default(false) // требуется ли проверка ИИ
  expectedAnswer   AnswerType      @default(TEXT) // тип ожидаемого ответа
  maxScore         Int             @default(10) // максимальный балл
  formSchema       Json?           // JSON-схема динамической формы ответа
  aiRubric         String?         // Текст критериев для ИИ-проверки конкретного шага
  isRequired       Boolean         @default(true) // Обязателен ли шаг для завершения модуля
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  submissions      Submission[]

  @@unique([moduleId, index]) // уникальность индекса в рамках модуля
  @@index([moduleId])
}

enum StepType {
  INFO
  TASK
  QUIZ
  EXAM
}

enum AnswerType {
  TEXT
  AUDIO
  VIDEO
  FILE
}

// Прогресс пользователя по модулям
model Enrollment {
  id        String         @id @default(cuid())
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  module    CourseModule   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  moduleId  String

  status    ModuleStatus   @default(LOCKED) // LOCKED, IN_PROGRESS, COMPLETED
  unlockedBy User?         @relation("UnlockedBy", fields: [unlockedById], references: [id]) // Куратор, открывший модуль
  unlockedById String?
  unlockedAt DateTime?     // Когда модуль был открыт
  completedAt DateTime?    // Когда модуль был завершен

  @@unique([userId, moduleId]) // один пользователь - один enrollment на модуль
  @@index([userId])
  @@index([moduleId])
}

enum ModuleStatus {
  LOCKED
  IN_PROGRESS
  COMPLETED
}

// Сдачи заданий обучающимися
model Submission {
  id             String          @id @default(cuid())
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String
  module         CourseModule    @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  moduleId       String
  step           CourseStep      @relation(fields: [stepId], references: [id], onDelete: Cascade)
  stepId         String

  answerText     String?         // Текстовый ответ
  answerFileId   String?         // file_id из Telegram (для аудио/видео/файлов)
  answerType     AnswerType      @default(TEXT)

  aiScore        Float?          // Оценка от ИИ (0-maxScore)
  aiFeedback     String?         // Комментарий от ИИ
  curatorScore   Float?          // Финальная оценка куратора
  curatorFeedback String?        // Комментарий куратора

  status         SubmissionStatus @default(SENT) // SENT, AI_REVIEWED, CURATOR_APPROVED, CURATOR_RETURNED

  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  @@unique([userId, stepId]) // один пользователь может сдать шаг только один раз
  @@index([userId])
  @@index([moduleId])
  @@index([stepId])
  @@index([status]) // для быстрого поиска по статусу
}

enum SubmissionStatus {
  SENT
  AI_REVIEWED
  CURATOR_APPROVED
  CURATOR_RETURNED
}


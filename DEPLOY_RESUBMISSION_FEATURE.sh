#!/bin/bash

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${BLUE}üöÄ –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ '–ó–∞–ø—Ä–æ—Å–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É –æ—Ç–≤–µ—Ç–∞'${NC}"
echo "=========================================="
echo ""

# 1. Git pull
echo -e "${BLUE}üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∏–∑ Git...${NC}"
git pull
if [ $? -ne 0 ]; then
  echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π${NC}"
  exit 1
fi
echo ""

# 2. –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
echo -e "${BLUE}üóÑÔ∏è  –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –ë–î...${NC}"
cd backend
npx prisma migrate deploy
if [ $? -ne 0 ]; then
  echo -e "${YELLOW}‚ö†Ô∏è  –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞. –ï—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—Ä—É—á–Ω—É—é:${NC}"
  echo -e "${YELLOW}   npx prisma migrate dev --name add_resubmission_fields${NC}"
fi
echo ""

# 3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Prisma Client
echo -e "${BLUE}üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Prisma Client...${NC}"
npx prisma generate
if [ $? -ne 0 ]; then
  echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Prisma Client${NC}"
  exit 1
fi
echo ""

# 4. –°–±–æ—Ä–∫–∞ backend
echo -e "${BLUE}üî® –°–±–æ—Ä–∫–∞ backend...${NC}"
npm run build
if [ $? -ne 0 ]; then
  echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ backend${NC}"
  exit 1
fi
echo ""

# 5. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ backend
echo -e "${BLUE}üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ backend...${NC}"
pm2 restart minto-backend
if [ $? -ne 0 ]; then
  echo -e "${YELLOW}‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —á–µ—Ä–µ–∑ PM2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤—Ä—É—á–Ω—É—é.${NC}"
fi
echo ""

# 6. –°–±–æ—Ä–∫–∞ TMA
echo -e "${BLUE}üé® –°–±–æ—Ä–∫–∞ TMA (frontend)...${NC}"
cd ../tma
npm run build
if [ $? -ne 0 ]; then
  echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ TMA${NC}"
  exit 1
fi
cd ..
echo ""

# 7. –°—Ç–∞—Ç—É—Å PM2
echo -e "${BLUE}üìä –°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ PM2...${NC}"
pm2 status
echo ""

# 8. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API
echo -e "${BLUE}üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ backend API...${NC}"
curl -I https://tma.n8nrgimprovise.space/api/auth/telegram-webapp 2>/dev/null | head -n 1
echo ""

# 9. –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏
echo -e "${BLUE}üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ backend...${NC}"
pm2 logs minto-backend --lines 30 --nostream
echo ""

echo -e "${GREEN}‚úÖ –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!${NC}"
echo ""
echo -e "${BLUE}üìù –ß—Ç–æ –±—ã–ª–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ:${NC}"
echo "  1. ‚úÖ Backend: –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è resubmissionRequested –∏ resubmissionRequestedAt –≤ Submission"
echo "  2. ‚úÖ Backend: –ù–æ–≤—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç POST /submissions/:id/request-resubmission"
echo "  3. ‚úÖ Backend: –ú–µ—Ç–æ–¥ SubmissionsService.requestResubmission —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ –≤ Telegram"
echo "  4. ‚úÖ TMA: –ö–Ω–æ–ø–∫–∞ 'üîÑ –ó–∞–ø—Ä–æ—Å–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É' –¥–ª—è —É—á–µ–Ω–∏–∫–æ–≤"
echo "  5. ‚úÖ TMA: –ë–µ–π–¥–∂ '–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω' –ø—Ä–∏ resubmissionRequested = true"
echo "  6. ‚úÖ TMA: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –∫—É—Ä–∞—Ç–æ—Ä–æ–≤ (–æ—Ä–∞–Ω–∂–µ–≤—ã–π –±–µ–π–¥–∂)"
echo ""
echo -e "${BLUE}üß™ –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:${NC}"
echo ""
echo -e "${YELLOW}–ö–∞–∫ —É—á–µ–Ω–∏–∫ (LEARNER):${NC}"
echo "  1. –û—Ç–∫—Ä–æ–π—Ç–µ TMA –∫–∞–∫ —É—á–µ–Ω–∏–∫"
echo "  2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –æ—Ç–≤–µ—Ç –Ω–∞ –ª—é–±–æ–µ –∑–∞–¥–∞–Ω–∏–µ"
echo "  3. –£–±–µ–¥–∏—Ç–µ—Å—å:"
echo "     - –ü–æ—è–≤–∏–ª–∞—Å—å –∫–Ω–æ–ø–∫–∞ 'üîÑ –ó–∞–ø—Ä–æ—Å–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É'"
echo "     - –ü—Ä–∏ –∫–ª–∏–∫–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è alert –∏ –∫–Ω–æ–ø–∫–∞ –∑–∞–º–µ–Ω—è–µ—Ç—Å—è –±–µ–π–¥–∂–µ–º"
echo "     - –ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –±–µ–π–¥–∂ –æ—Å—Ç–∞—ë—Ç—Å—è"
echo ""
echo -e "${YELLOW}–ö–∞–∫ –∫—É—Ä–∞—Ç–æ—Ä (CURATOR/ADMIN):${NC}"
echo "  1. –û—Ç–∫—Ä–æ–π—Ç–µ TMA –∫–∞–∫ –∫—É—Ä–∞—Ç–æ—Ä"
echo "  2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —É—á–µ–Ω–∏–∫–∞"
echo "  3. –ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–¥–∞—á–∏:"
echo "     - –ù–∞ –∫–∞—Ä—Ç–æ—á–∫–µ —Å –∑–∞–ø—Ä–æ—Å–æ–º –≤–∏–¥–Ω–∞ –æ—Ä–∞–Ω–∂–µ–≤–∞—è –ø–ª–∞—à–∫–∞"
echo "     - –í Telegram –ø—Ä–∏—à–ª–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–ø—Ä–æ—Å–µ"
echo ""
echo -e "${YELLOW}üìñ –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏: —Å–º. RESUBMISSION_REQUEST_FEATURE.md${NC}"


# Исправление: Сохранение шагов курса в редакторе

## Проблема

При редактировании шага курса в TMA (вкладка "Конструктор" → редактирование шага):
- Кнопка "Сохранить" показывает состояние загрузки
- Запрос уходит на backend
- Но изменения не сохраняются
- UI зависает или показывает неясную ошибку

## Причина

### 1. Лишнее поле в запросе
Frontend отправлял поле `moduleId` при обновлении шага (`PATCH /admin/course/steps/:id`), но backend DTO (`UpdateStepDto`) не ожидает этого поля.

```typescript
// Frontend отправлял:
{
  moduleId: "...",  // ❌ Лишнее поле
  title: "...",
  content: "...",
  ...
}

// Backend ожидал:
{
  title: "...",
  content: "...",
  ...
  // moduleId НЕ должен меняться при обновлении
}
```

### 2. Плохая обработка ошибок
Frontend не показывал понятные сообщения об ошибках пользователю.

## Решение

### Frontend: CourseStepEditorPage.tsx

**1. Убрали `moduleId` из запроса при обновлении:**
```typescript
if (isNew) {
  // При создании отправляем всё, включая moduleId
  await api.post('/admin/course/steps', dataToSave);
} else {
  // При обновлении НЕ отправляем moduleId (он не должен меняться)
  const { moduleId: _, ...updateData } = dataToSave;
  await api.patch(`/admin/course/steps/${stepId}`, updateData);
}
```

**2. Добавили валидацию перед отправкой:**
```typescript
if (!formData.title.trim()) {
  alert('❌ Пожалуйста, укажите название шага');
  return;
}

if (!formData.content.trim()) {
  alert('❌ Пожалуйста, укажите содержание шага');
  return;
}
```

**3. Улучшили обработку ошибок:**
```typescript
catch (err: any) {
  let errorMessage = 'Неизвестная ошибка';
  
  if (err.response) {
    // Ошибка от сервера
    if (err.response.data?.message) {
      errorMessage = Array.isArray(err.response.data.message)
        ? err.response.data.message.join('\n')
        : err.response.data.message;
    } else if (err.response.status === 400) {
      errorMessage = 'Некорректные данные. Проверьте все поля.';
    } else if (err.response.status === 401) {
      errorMessage = 'Ошибка авторизации. Перезайдите в приложение.';
    } else if (err.response.status === 403) {
      errorMessage = 'Недостаточно прав для этого действия.';
    } else if (err.response.status === 404) {
      errorMessage = 'Шаг не найден.';
    } else if (err.response.status === 409) {
      errorMessage = 'Конфликт данных. Возможно, шаг с таким индексом уже существует.';
    } else if (err.response.status >= 500) {
      errorMessage = 'Ошибка сервера. Попробуйте позже.';
    }
  } else if (err.request) {
    errorMessage = 'Нет связи с сервером. Проверьте интернет-соединение.';
  }
  
  alert(`❌ Не удалось сохранить шаг:\n\n${errorMessage}`);
}
```

**4. Добавили уведомление об успехе:**
```typescript
// Показываем уведомление об успехе
alert('✅ Шаг успешно сохранён!');

// Возвращаемся к списку шагов
navigate(`/curator/course/modules/${moduleId}/steps`);
```

**5. Очистка пустых строк:**
```typescript
const dataToSave = {
  ...formData,
  formSchema,
  // Если aiRubric пустая строка, отправляем undefined
  aiRubric: formData.aiRubric?.trim() || undefined,
};
```

## Проверка работы

### 1. Создание нового шага

```
1. TMA → Конструктор → Выбрать курс
2. Выбрать модуль → "Добавить шаг"
3. Заполнить:
   - Название: "Задание 1.4"
   - Тип: "Задание"
   - Содержание: "Опишите структуру документа..."
   - Остальные поля по желанию
4. Нажать "Сохранить"
5. ✅ Должно показать "Шаг успешно сохранён!"
6. ✅ Должен вернуться к списку шагов
7. ✅ Новый шаг должен появиться в списке
```

### 2. Редактирование существующего шага

```
1. TMA → Конструктор → Выбрать курс → Выбрать модуль
2. Нажать на существующий шаг
3. Изменить название на "Задание 1.1 (обновлено)"
4. Изменить содержание
5. Нажать "Сохранить"
6. ✅ Должно показать "Шаг успешно сохранён!"
7. ✅ Должен вернуться к списку шагов
8. ✅ Изменения должны сохраниться
```

### 3. Обработка ошибок

**Тест 1: Пустое название**
```
1. Очистить поле "Название шага"
2. Нажать "Сохранить"
3. ✅ Должно показать "Пожалуйста, укажите название шага"
4. ✅ Кнопка не должна зависнуть
```

**Тест 2: Пустое содержание**
```
1. Очистить поле "Содержание"
2. Нажать "Сохранить"
3. ✅ Должно показать "Пожалуйста, укажите содержание шага"
```

**Тест 3: Конфликт индексов**
```
1. Изменить индекс на уже существующий
2. Нажать "Сохранить"
3. ✅ Должно показать понятную ошибку про конфликт
4. ✅ Кнопка должна вернуться в нормальное состояние
```

**Тест 4: Изменение критичных полей (для шага с submissions)**
```
1. Открыть шаг, по которому уже есть сдачи
2. Попытаться изменить "Тип шага" или "Максимальный балл"
3. Нажать "Сохранить"
4. ✅ Должно показать ошибку "Cannot modify critical fields..."
```

## Backend защита

Backend уже корректно обрабатывает обновление шагов:

**UpdateStepDto** — все поля опциональны (правильно для PATCH):
```typescript
export class UpdateStepDto {
  @IsOptional() title?: string;
  @IsOptional() type?: StepType;
  @IsOptional() index?: number;
  @IsOptional() content?: string;
  @IsOptional() expectedAnswer?: AnswerType;
  @IsOptional() requiresAiReview?: boolean;
  @IsOptional() maxScore?: number;
  @IsOptional() isRequired?: boolean;
  @IsOptional() formSchema?: any;
  @IsOptional() aiRubric?: string;
}
```

**updateStep()** — проверяет:
1. ✅ Существование шага
2. ✅ Наличие submissions
3. ✅ Запрет изменения критичных полей (type, expectedAnswer, maxScore, isRequired) если есть submissions
4. ✅ Конфликты индексов

## Развёртывание

```bash
ssh root@79.132.140.13
cd /var/www/tma_education

# 1. Получить обновления
git pull

# 2. Пересобрать TMA (backend не требует изменений)
cd tma
npm run build

# 3. Проверить
curl -I https://tma.n8nrgimprovise.space
```

## Изменённые файлы

- `tma/src/pages/CourseStepEditorPage.tsx`:
  - Убран `moduleId` из запроса при обновлении
  - Добавлена валидация перед отправкой
  - Улучшена обработка ошибок с понятными сообщениями
  - Добавлено уведомление об успехе
  - Очистка пустых строк (aiRubric)

## Возможные ошибки и решения

### Ошибка: "Некорректные данные"
**Причина:** Поля не прошли валидацию на backend  
**Решение:** Проверьте, что все обязательные поля заполнены

### Ошибка: "Конфликт данных"
**Причина:** Шаг с таким индексом уже существует в модуле  
**Решение:** Измените индекс на уникальный

### Ошибка: "Cannot modify critical fields"
**Причина:** Попытка изменить type/maxScore/isRequired для шага с submissions  
**Решение:** Эти поля нельзя менять, если по шагу уже есть сдачи

### Кнопка "Сохранить" disabled
**Причина:** Пустое название или содержание  
**Решение:** Заполните все обязательные поля

---

**Версия:** 1.0  
**Дата:** 2025-11-29  
**Проблема:** Не сохраняются изменения шагов курса  
**Решение:** Исправлена отправка данных + улучшена обработка ошибок


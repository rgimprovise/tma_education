#!/bin/bash

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${BLUE}üöÄ –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç –¥–ª—è –∫—É—Ä–∞—Ç–æ—Ä–∞${NC}"
echo "=========================================="
echo ""

# 1. Git pull
echo -e "${BLUE}üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∏–∑ Git...${NC}"
git pull
if [ $? -ne 0 ]; then
  echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π${NC}"
  exit 1
fi
echo ""

# 2. –°–±–æ—Ä–∫–∞ backend
echo -e "${BLUE}üî® –°–±–æ—Ä–∫–∞ backend...${NC}"
cd backend
npm run build
if [ $? -ne 0 ]; then
  echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ backend${NC}"
  exit 1
fi
echo ""

# 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ backend
echo -e "${BLUE}üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ backend...${NC}"
pm2 restart minto-backend
if [ $? -ne 0 ]; then
  echo -e "${YELLOW}‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —á–µ—Ä–µ–∑ PM2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤—Ä—É—á–Ω—É—é.${NC}"
fi
echo ""

# 4. –°–±–æ—Ä–∫–∞ TMA
echo -e "${BLUE}üé® –°–±–æ—Ä–∫–∞ TMA (frontend)...${NC}"
cd ../tma
npm run build
if [ $? -ne 0 ]; then
  echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ TMA${NC}"
  exit 1
fi
cd ..
echo ""

# 5. –°—Ç–∞—Ç—É—Å PM2
echo -e "${BLUE}üìä –°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ PM2...${NC}"
pm2 status
echo ""

# 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API
echo -e "${BLUE}üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ backend API...${NC}"
curl -I https://tma.n8nrgimprovise.space/api/auth/telegram-webapp 2>/dev/null | head -n 1
echo ""

# 7. –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏
echo -e "${BLUE}üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ backend...${NC}"
pm2 logs minto-backend --lines 30 --nostream
echo ""

echo -e "${GREEN}‚úÖ –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!${NC}"
echo ""
echo -e "${BLUE}üìù –ß—Ç–æ –±—ã–ª–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ:${NC}"
echo "  1. ‚úÖ Backend: –î–æ–±–∞–≤–ª–µ–Ω GET /admin/submissions/:id –¥–ª—è –¥–µ—Ç–∞–ª–µ–π —Å–¥–∞—á–∏"
echo "  2. ‚úÖ Backend: –û–±–Ω–æ–≤–ª—ë–Ω –º–µ—Ç–æ–¥ findById (–±–æ–ª—å—à–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —à–∞–≥–µ)"
echo "  3. ‚úÖ TMA: –ù–æ–≤—ã–π —ç–∫—Ä–∞–Ω CuratorSubmissionPage (/curator/submissions/:id)"
echo "  4. ‚úÖ TMA: –ö–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å–¥–∞—á –≤ CuratorUserPage"
echo "  5. ‚úÖ TMA: –§–æ—Ä–º–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å –æ–¥–æ–±—Ä–µ–Ω–∏–µ–º/–≤–æ–∑–≤—Ä–∞—Ç–æ–º"
echo "  6. ‚úÖ TMA: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ formSchema –≤ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤"
echo ""
echo -e "${BLUE}üß™ –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:${NC}"
echo ""
echo -e "${YELLOW}–ö–∞–∫ –∫—É—Ä–∞—Ç–æ—Ä (CURATOR/ADMIN):${NC}"
echo "  1. –û—Ç–∫—Ä–æ–π—Ç–µ TMA –∫–∞–∫ –∫—É—Ä–∞—Ç–æ—Ä"
echo "  2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ '–£—á–µ–Ω–∏–∫–∏' ‚Üí –≤—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–∞"
echo "  3. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –ª—é–±—É—é —Å–¥–∞—á—É –≤ –±–ª–æ–∫–µ '–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–¥–∞—á–∏'"
echo "  4. –£–±–µ–¥–∏—Ç–µ—Å—å:"
echo "     - –û—Ç–∫—Ä—ã–ª–∞—Å—å —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å –¥–µ—Ç–∞–ª—è–º–∏"
echo "     - –í–∏–¥–Ω–æ –æ—Ç–≤–µ—Ç —É—á–µ–Ω–∏–∫–∞, –æ—Ü–µ–Ω–∫—É –ò–ò, –∑–∞–¥–∞–Ω–∏–µ"
echo "     - –§–æ—Ä–º–∞ –¥–ª—è –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏—è –æ—Ü–µ–Ω–∫–∏ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è"
echo "     - –ö–Ω–æ–ø–∫–∏ '–û–¥–æ–±—Ä–∏—Ç—å' –∏ '–í–µ—Ä–Ω—É—Ç—å –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É' —Ä–∞–±–æ—Ç–∞—é—Ç"
echo "  5. –û–¥–æ–±—Ä–∏—Ç–µ —Ä–∞–±–æ—Ç—É:"
echo "     - –í–≤–µ–¥–∏—Ç–µ –æ—Ü–µ–Ω–∫—É (0..maxScore)"
echo "     - –í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"
echo "     - –ù–∞–∂–º–∏—Ç–µ '‚úÖ –û–¥–æ–±—Ä–∏—Ç—å'"
echo "     - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ alert –∏ –≤–æ–∑–≤—Ä–∞—Ç –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É"
echo "  6. –í–µ—Ä–Ω–∏—Ç–µ —Ä–∞–±–æ—Ç—É (–¥—Ä—É–≥—É—é —Å–¥–∞—á—É):"
echo "     - –í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"
echo "     - –ù–∞–∂–º–∏—Ç–µ 'üîÑ –í–µ—Ä–Ω—É—Ç—å –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É'"
echo "     - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
echo ""
echo -e "${YELLOW}–ö–∞–∫ —É—á–µ–Ω–∏–∫ (LEARNER):${NC}"
echo "  1. –û—Ç–∫—Ä–æ–π—Ç–µ TMA –∫–∞–∫ —É—á–µ–Ω–∏–∫"
echo "  2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –∫ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–æ–º—É –∑–∞–¥–∞–Ω–∏—é"
echo "  3. –£–±–µ–¥–∏—Ç–µ—Å—å:"
echo "     - –í–∏–¥–Ω–∞ –æ—Ü–µ–Ω–∫–∞ –∫—É—Ä–∞—Ç–æ—Ä–∞ (–µ—Å–ª–∏ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∞)"
echo "     - –í–∏–¥–µ–Ω –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫—É—Ä–∞—Ç–æ—Ä–∞"
echo "     - –ù–ï –≤–∏–¥–Ω–∞ –æ—Ü–µ–Ω–∫–∞ –ò–ò (—Ç–æ–ª—å–∫–æ –¥–ª—è –∫—É—Ä–∞—Ç–æ—Ä–æ–≤)"
echo "  4. –ï—Å–ª–∏ —Ä–∞–±–æ—Ç–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∞:"
echo "     - –í–∏–¥–µ–Ω –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫—É—Ä–∞—Ç–æ—Ä–∞"
echo "     - –î–æ—Å—Ç—É–ø–Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞"
echo ""
echo -e "${YELLOW}üìñ –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏: —Å–º. CURATOR_SUBMISSION_REVIEW_FEATURE.md${NC}"

